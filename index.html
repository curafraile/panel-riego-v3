<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Panel de Riego HÃ­brido</title>
  <script src="https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.2/firebase-database.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <h1>ðŸŒ± Panel de Riego HÃ­brido</h1>

  <div>
    <h3>Humedad en Vivo</h3>
    Zona 1: <span id="hum1">--</span>%<br>
    Zona 2: <span id="hum2">--</span>%<br>
    Estado Bomba: <span id="bomba">OFF</span><br>
    Origen: <span id="origen">auto</span><br>
  </div>

  <canvas id="grafico" width="600" height="300"></canvas>

  <script>
    // ================= CONFIG FIREBASE =================
    const firebaseConfig = {
      apiKey: "AIzaSyDm4UQ_tOSC36IfWjHwNOP2aYAy_iMjE9c",
      authDomain: "riego-hibrido-v3.firebaseapp.com",
      databaseURL: "https://riego-hibrido-v3-default-rtdb.firebaseio.com",
      projectId: "riego-hibrido-v3",
      storageBucket: "riego-hibrido-v3.firebasestorage.app",
      messagingSenderId: "991487752193",
      appId: "1:991487752193:web:3369272f5ebbb357b6a800"
    };
    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // ================= DOM =================
    const hum1 = document.getElementById("hum1");
    const hum2 = document.getElementById("hum2");
    const bomba = document.getElementById("bomba");
    const origen = document.getElementById("origen");

    // ================= GRAFICO =================
    const ctx = document.getElementById("grafico").getContext("2d");
    const chart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: [],
        datasets: [
          { label: 'Zona 1 (%)', data: [], borderColor: 'blue', fill: false },
          { label: 'Zona 2 (%)', data: [], borderColor: 'green', fill: false }
        ]
      },
      options: { responsive: true }
    });

    // ================= LECTURAS EN VIVO =================
    db.ref("riego/zona1").on("value", snap => hum1.textContent = snap.val());
    db.ref("riego/zona2").on("value", snap => hum2.textContent = snap.val());
    db.ref("riego/bomba").on("value", snap => bomba.textContent = snap.val());
    db.ref("riego/origen").on("value", snap => origen.textContent = snap.val());

    // ================= HISTORIAL =================
    db.ref("riego/historial").limitToLast(20).on("child_added", snap => {
      const val = snap.val();
      if(val){
        const fecha = new Date(val.t * 1000);
        chart.data.labels.push(fecha.toLocaleTimeString());
        chart.data.datasets[0].data.push(val.z1);
        chart.data.datasets[1].data.push(val.z2);
        chart.update();
      }
    });
  </script>
</body>
</html>
