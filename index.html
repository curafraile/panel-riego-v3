<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Riego V3</title>
    <!-- Carga de librerías de Firebase y Chart.js -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Estilos base (Diseño limpio y responsive) */
        body { font-family: 'Inter', sans-serif; text-align: center; padding: 2em; background: #f0f0f0; }
        h1 { color: #2c3e50; margin-bottom: 0.5em; }
        .dato { 
            font-size: 2em; 
            margin: 1em 0; 
            padding: 0.5em; 
            border-radius: 10px; 
            display: inline-block; 
            transition: background 0.3s;
            color: white; /* Mejor contraste en los colores de estado */
            font-weight: bold;
            min-width: 250px;
        }
        .riego, .origen { margin-top: 1em; font-weight: bold; color: #2980b9; }
        
        /* Estilo de Botones */
        button, select { 
            padding: 0.5em 1em; 
            font-size: 1em; 
            margin: 0.5em; 
            border-radius: 8px; 
            transition: transform 0.1s; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); 
        }
        button { border: none; cursor: pointer; color: white; }
        button:hover { opacity: 0.9; transform: translateY(-1px); }
        .on { background: #27ae60; }
        .off { background: #c0392b; }
        .auto { background: #3498db; }
        .manual { background: #8e44ad; }
        
        /* Contenedor del gráfico y notificaciones */
        .chart-container { max-width: 800px; margin: 2em auto; padding: 1em; background: white; border-radius: 10px; box-shadow: 0 0 15px rgba(0,0,0,0.05); }
        #notificacion { 
            background: #d1ecf1; 
            color: #0c5460; 
            padding: 10px; 
            border: 1px solid #bee5eb; 
            border-radius: 5px; 
            margin: 1em auto; 
            max-width: 80%;
            opacity: 0;
            transition: opacity 0.5s;
        }
        #notificacion.show { opacity: 1; }
        
        /* Responsive para dispositivos móviles */
        @media (max-width: 600px) {
            .dato { font-size: 1.5em; display: block; width: 90%; margin: 1em auto; }
            button { display: block; width: 90%; margin: 0.5em auto; }
            select { margin: 0.5em 0.2em; width: 45%; }
        }
    </style>
</head>
<body>
    <h1>🌱 Panel de Riego V3</h1>
    
    <!-- Secciones de Datos en Tiempo Real -->
    <div id="humedadBox" class="dato">Humedad actual: <span id="humedad">--</span>%</div>
    <div class="riego">Estado de riego: <span id="estadoRiego">--</span></div>
    <div class="origen">Origen del cambio: <span id="origenRiego">--</span></div>
    
    <!-- Contenedor para notificaciones -->
    <div id="notificacion"></div>

    <!-- Botones de Control -->
    <button class="on" onclick="activarRiego()">Activar riego</button>
    <button class="off" onclick="desactivarRiego()">Desactivar riego</button>
    <button class="auto" onclick="activarAutomatico()">Modo automático</button>
    <button class="manual" onclick="activarManual()">Modo manual</button>

    <!-- Sección de Historial -->
    <div style="margin-top: 1.5em;">
        <h3>📅 Consultar historial</h3>
        <select id="mes">
            <option value="1">Enero</option>
            <option value="2">Febrero</option>
            <option value="3">Marzo</option>
            <option value="4">Abril</option>
            <option value="5">Mayo</option>
            <option value="6">Junio</option>
            <option value="7">Julio</option>
            <option value="8">Agosto</option>
            <option value="9" selected>Septiembre</option>
            <option value="10">Octubre</option>
            <option value="11">Noviembre</option>
            <option value="12">Diciembre</option>
        </select>
        <select id="anio">
            <option value="2024">2024</option>
            <option value="2025" selected>2025</option>
        </select>
        <button onclick="cargarHistorial()">Ver historial</button>
    </div>

    <!-- Gráfico -->
    <div class="chart-container">
        <canvas id="graficoHumedad" width="400" height="200"></canvas>
    </div>

    <script>
        // --- CONFIGURACIÓN DE FIREBASE (riego-hibrido-v3) ---
        const firebaseConfig = {
            apiKey: "AIzaSyDm4UQ_tOSC36IfWjHwNOP2aYAy_iMjE9c",
            authDomain: "riego-hibrido-v3.firebaseapp.com",
            databaseURL: "https://riego-hibrido-v3-default-rtdb.firebaseio.com",
            projectId: "riego-hibrido-v3",
            storageBucket: "riego-hibrido-v3.firebasestorage.app",
            messagingSenderId: "991487752193",
            appId: "1:991487752193:web:3369272f5ebbb357b6a800"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const notificacionElement = document.getElementById("notificacion");

        // Función de utilidad para mostrar mensajes
        function mostrarNotificacion(mensaje, duracion = 3000) {
            notificacionElement.textContent = mensaje;
            notificacionElement.classList.add("show");
            setTimeout(() => {
                notificacionElement.classList.remove("show");
            }, duracion);
        }

        // ------------------------------------------------------------------
        // LECTURA DE DATOS EN TIEMPO REAL
        // ------------------------------------------------------------------

        // Humedad
        db.ref("riego/humedad").on("value", snapshot => {
            const valor = snapshot.val();
            const humedad = document.getElementById("humedad");
            const box = document.getElementById("humedadBox");
            humedad.textContent = valor ?? "--";

            // Control visual por umbrales: Seco (<30% - Rojo), Medio (30-60% - Amarillo), Húmedo (>60% - Verde)
            if (valor < 30) box.style.background = "#e74c3c"; 
            else if (valor <= 60) box.style.background = "#f1c40f"; 
            else box.style.background = "#2ecc71"; 
        });

        // Estado de Riego (Bomba: ON/OFF)
        db.ref("riego/bomba").on("value", snapshot => {
            const estado = snapshot.val();
            let texto = "--";
            if (estado === "ON") texto = "💧 Activada";
            else if (estado === "OFF") texto = "🛑 Desactivada";
            document.getElementById("estadoRiego").textContent = texto;
        });

        // Origen del Control (auto/manual)
        db.ref("riego/origen").on("value", snapshot => {
            const origen = snapshot.val();
            let texto = "--";
            if (origen === "auto") texto = "🔄 Automático";
            else if (origen === "manual") texto = "🧑‍🔧 Manual";
            document.getElementById("origenRiego").textContent = texto;
        });

        // ------------------------------------------------------------------
        // FUNCIONES DE CONTROL (ESCRITURA a Firebase)
        // ------------------------------------------------------------------

        function activarRiego() {
            db.ref("riego/bomba").set("ON");
            db.ref("riego/origen").set("manual");
            mostrarNotificacion("💧 Riego activado manualmente.");
        }

        function desactivarRiego() {
            db.ref("riego/bomba").set("OFF");
            db.ref("riego/origen").set("manual");
            mostrarNotificacion("🛑 Riego desactivado manualmente.");
        }

        function activarAutomatico() {
            db.ref("riego/origen").set("auto");
            mostrarNotificacion("🔄 Modo automático activado. El ESP32 retoma el control.");
        }

        function activarManual() {
            db.ref("riego/origen").set("manual");
            mostrarNotificacion("🧑‍🔧 Modo manual activado. El ESP32 obedecerá las órdenes de los botones ON/OFF.");
        }

        // ------------------------------------------------------------------
        // LÓGICA DEL GRÁFICO (Historial)
        // ------------------------------------------------------------------

        const ctx = document.getElementById("graficoHumedad").getContext("2d");
        const grafico = new Chart(ctx, {
            type: "line",
            data: {
                labels: [],
                datasets: [{
                    label: "Humedad (%)",
                    data: [],
                    borderColor: "#27ae60",
                    backgroundColor: "rgba(39,174,96,0.2)",
                    fill: true,
                    tension: 0.3
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: { title: { display: true, text: "Fecha y hora" } },
                    y: { min: 0, max: 100, title: { display: true, text: "Humedad (%)" } }
                }
            }
        });

        // Función auxiliar para procesar los datos de Firebase y actualizar el gráfico
        function procesarDatosHistorial(snapshot, titulo) {
            const datos = snapshot.val();
            const etiquetas = [];
            const valores = [];

            if (datos) {
                // Iterar sobre DÍA -> HORA:MINUTO -> VALOR
                for (const dia in datos) {
                    for (const hora in datos[dia]) {
                        // Se extrae el mes y el año de la referencia (parent keys)
                        const mes = snapshot.ref.parent.key; 
                        const anio = snapshot.ref.parent.parent.key;
                        etiquetas.push(`${dia}/${mes}/${anio} ${hora}`);
                        valores.push(datos[dia][hora]);
                    }
                }
            }

            grafico.data.labels = etiquetas;
            grafico.data.datasets[0].data = valores;
            grafico.data.datasets[0].label = `Humedad (%) - ${titulo}`;
            grafico.update();
        }

        // Carga y escucha en tiempo real de los datos del mes actual
        function cargarUltimaSemana() {
            const hoy = new Date();
            const año = hoy.getFullYear();
            const mes = hoy.getMonth() + 1;
            
            // on() escucha los cambios en tiempo real
            db.ref(`riego/historial/${año}/${mes}`).on("value", snapshot => {
                procesarDatosHistorial(snapshot, `Datos en tiempo real de ${mes}/${año}`);
            });
        }

        // Carga estática (once()) del historial solicitado por el usuario
        function cargarHistorial() {
            const mes = document.getElementById("mes").value;
            const anio = document.getElementById("anio").value;
            
            // once() carga los datos una sola vez
            db.ref(`riego/historial/${anio}/${mes}`).once("value").then(snapshot => {
                procesarDatosHistorial(snapshot, `Historial completo de ${mes}/${anio}`);
            });
        }

        cargarUltimaSemana(); // Inicia la carga de datos al abrir la página
    </script>
</body>
</html>
