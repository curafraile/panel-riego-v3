<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Panel de Riego H√≠brido</title>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body { font-family: sans-serif; text-align: center; padding: 2em; background: #f0f0f0; }
h1 { color: #2c3e50; margin-bottom: 1em; }
.zona-box { display: inline-block; width: 180px; padding: 1em; margin: 0.5em; border-radius: 10px; font-size: 1.5em; color: white; }
.zona1 { background: #3498db; }
.zona2 { background: #e67e22; }
.estado { margin-top: 1em; font-weight: bold; font-size: 1.3em; }
button, select { padding: 0.5em 1em; font-size: 1em; margin: 0.5em; border-radius: 5px; cursor: pointer; color: white; border: none; }
button:hover { opacity: 0.9; }
.on { background: #27ae60; }
.off { background: #c0392b; }
.auto { background: #3498db; }
.manual { background: #8e44ad; }
canvas { margin-top: 2em; }
</style>
</head>
<body>
<h1>üå± Panel de Riego H√≠brido</h1>

<div>
    <div id="zona1Box" class="zona-box zona1">Zona 1: <span id="humedad1">--</span>%</div>
    <div id="zona2Box" class="zona-box zona2">Zona 2: <span id="humedad2">--</span>%</div>
</div>

<div class="estado">Estado de riego: <span id="estadoRiego">--</span></div>
<div class="estado">Origen: <span id="origenRiego">--</span></div>

<div>
    <label for="selectZona">Seleccionar zona:</label>
    <select id="selectZona">
        <option value="1">Zona 1</option>
        <option value="2">Zona 2</option>
        <option value="0">Ambas</option>
    </select>
</div>

<div>
    <button class="on" onclick="activarRiego()">Activar riego</button>
    <button class="off" onclick="desactivarRiego()">Desactivar riego</button>
    <button class="auto" onclick="activarAutomatico()">Modo autom√°tico</button>
    <button class="manual" onclick="activarManual()">Modo manual</button>
</div>

<div>
    <h3>üìÖ Consultar historial</h3>
    <p>Mostrando datos de los √∫ltimos 7 d√≠as por defecto.</p>
    <button onclick="cargarHistorialPersonalizado()">Ver √∫ltimos 7 d√≠as</button>
</div>

<canvas id="graficoHumedad" width="600" height="300"></canvas>

<script>
// La configuraci√≥n de Firebase es la misma
const firebaseConfig = {
    apiKey: "AIzaSyDm4UQ_tOSC36IfWjHwNOP2aYAy_iMjE9c", // Asume que esta es la correcta
    databaseURL: "https://riego-hibrido-v3-default-rtdb.firebaseio.com",
    // ... otros campos no utilizados son opcionales
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const historialRef = db.ref("riego/historial");

// ======================= ACTUALIZACI√ìN EN TIEMPO REAL =======================

// Humedad y cajas de color
db.ref("riego/zona1").on("value", snap => {
    const val = snap.val();
    document.getElementById("humedad1").textContent = val ?? "--";
    const box = document.getElementById("zona1Box");
    // L√≥gica de colores adaptada: Rojo (Seco <30), Amarillo (Normal 30-60), Azul (H√∫medo >60)
    box.style.background = val < 30 ? "#c0392b" : val < 60 ? "#f1c40f" : "#3498db";
});
db.ref("riego/zona2").on("value", snap => {
    const val = snap.val();
    document.getElementById("humedad2").textContent = val ?? "--";
    const box = document.getElementById("zona2Box");
    // L√≥gica de colores adaptada: Rojo (Seco <30), Naranja (Normal 30-60), Naranja oscuro (H√∫medo >60)
    box.style.background = val < 30 ? "#c0392b" : val < 60 ? "#f39c12" : "#e67e22";
});

// Estado de riego
db.ref("riego/bomba").on("value", snap => {
    const val = snap.val();
    let texto = "--";
    if (val === "ON") texto = "üíß Activada"; else if (val === "OFF" || val === "off") texto = "üõë Desactivada";
    document.getElementById("estadoRiego").textContent = texto;
});
db.ref("riego/origen").on("value", snap => {
    const val = snap.val();
    document.getElementById("origenRiego").textContent = val === "auto" ? "üîÑ Autom√°tico" : "üßë‚Äçüîß Manual";
});

// ======================= FUNCIONES DE CONTROL =======================

function setControlValues(origen, zona1, zona2, mensaje) {
    db.ref("riego/origen").set(origen);
    // Controla solo la bomba (estado de riego) si es modo manual
    if (origen === "manual") {
        db.ref("riego/bomba").set(zona1 ? "ON" : "OFF");
        // Nota: Los controles del motor (zona1/zona2) son manejados por el ESP32 en modo 'auto',
        // pero se mantienen para permitir el control manual del motor si es necesario.
        db.ref("riego/motor/zona1").set(zona1);
        db.ref("riego/motor/zona2").set(zona2);
    }
    alert(mensaje);
}

function activarRiego() {
    const z = document.getElementById("selectZona").value;
    setControlValues("manual", z === "1" || z === "0", z === "2" || z === "0", "üíß Riego activado manualmente");
}
function desactivarRiego() {
    setControlValues("manual", false, false, "üõë Riego desactivado manualmente");
}
function activarAutomatico() {
    // En modo autom√°tico, solo se cambia el origen. El ESP32 decide la bomba y el motor.
    db.ref("riego/origen").set("auto");
    alert("üîÑ Modo autom√°tico activado. El riego se basar√° en los umbrales de humedad.");
}
function activarManual() {
    // Solo se cambia el origen. El usuario debe controlar la bomba/motor con los botones de arriba.
    db.ref("riego/origen").set("manual");
    alert("üßë‚Äçüîß Modo manual activado. Usa los botones Activar/Desactivar riego.");
}

// ======================= L√ìGICA DE GR√ÅFICO DE HISTORIAL =======================

const ctx = document.getElementById("graficoHumedad").getContext("2d");
const grafico = new Chart(ctx, {
    type: "line",
    data: {
        labels: [],
        datasets: [
            { label: "Zona 1", data: [], borderColor: "#3498db", backgroundColor: "rgba(52,152,219,0.2)", fill: true, tension: 0.3 },
            { label: "Zona 2", data: [], borderColor: "#e67e22", backgroundColor: "rgba(230,126,34,0.2)", fill: true, tension: 0.3 }
        ]
    },
    options: {
        scales: {
            x: { title: { display: true, text: "Fecha y hora" } },
            y: { min: 0, max: 100, title: { display: true, text: "Humedad (%)" } }
        }
    }
});

function cargarHistorial(tiempoInicial) {
    // La clave es la marca de tiempo UNIX (en segundos)
    historialRef
        .orderByKey() // Ordena por la clave (timestamp UNIX)
        .startAt(tiempoInicial.toString()) // Filtra desde el tiempo inicial
        .once("value")
        .then(snap => {
            const datos = snap.val() || {};
            const etiquetas = [], data1 = [], data2 = [];

            // Recorre los datos y los formatea
            for (const timestampKey in datos) {
                const registro = datos[timestampKey];
                // El timestamp es en SEGUNDOS (del ESP32), se convierte a milisegundos para JavaScript
                const date = new Date(parseInt(timestampKey) * 1000); 

                // Formato de etiqueta: "DD/MM HH:mm"
                const etiqueta = `${date.getDate().toString().padStart(2, '0')}/${(date.getMonth() + 1).toString().padStart(2, '0')} ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;

                etiquetas.push(etiqueta);
                data1.push(registro.z1 ?? 0);
                data2.push(registro.z2 ?? 0);
            }

            grafico.data.labels = etiquetas;
            grafico.data.datasets[0].data = data1;
            grafico.data.datasets[1].data = data2;
            grafico.update();

            if (etiquetas.length === 0) {
                console.warn("No hay datos disponibles en el rango de tiempo seleccionado.");
            }
        })
        .catch(error => {
            console.error("Error al cargar el historial:", error);
            alert("Hubo un error al cargar el historial.");
        });
}

function cargarHistorialPersonalizado() {
    // 7 d√≠as = 7 d√≠as * 24 horas/d√≠a * 3600 segundos/hora = 604800 segundos
    const tiempoHace7Dias = Math.floor(Date.now() / 1000) - (7 * 24 * 3600); 
    cargarHistorial(tiempoHace7Dias);
    alert("Cargando historial de los √∫ltimos 7 d√≠as...");
}

// Carga inicial al cargar la p√°gina: muestra los √∫ltimos 7 d√≠as
window.onload = cargarHistorialPersonalizado;

</script>
</body>
</html>
