<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Panel de Riego V3</title>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script> <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: sans-serif; text-align: center; padding: 2em; background: #f0f0f0; }
        h1 { color: #2c3e50; }
        .dato { font-size: 2em; margin: 1em 0; padding: 0.5em; border-radius: 10px; display: inline-block; }
        .riego, .origen { margin-top: 1em; font-weight: bold; color: #2980b9; }
        button, select, input[type="email"], input[type="password"] { padding: 0.5em 1em; font-size: 1em; margin: 0.5em; border-radius: 5px; border: 1px solid #ccc; }
        button { border: none; cursor: pointer; color: white; }
        button:hover { opacity: 0.9; }
        .on { background: #27ae60; }
        .off { background: #c0392b; }
        .auto { background: #3498db; }
        .manual { background: #8e44ad; }
        canvas { margin-top: 2em; }
        #logout-btn { position: absolute; top: 10px; right: 10px; }
    </style>
</head>
<body>

    <div id="login-box" style="margin-top: 50px;">
        <h2>üîí Acceso a Riego H√≠brido V3</h2>
        <form id="login-form">
            <input type="email" id="email" placeholder="Correo electr√≥nico" required><br><br>
            <input type="password" id="password" placeholder="Contrase√±a" required><br><br>
            <button type="submit" class="on">Iniciar Sesi√≥n</button>
        </form>
        <button class="auto" onclick="mostrarRegistro()">¬øNo tienes cuenta? Reg√≠strate</button>
    </div>

    <div id="signup-box" style="display:none; margin-top: 20px;">
        <h2>‚úçÔ∏è Crear Cuenta V3</h2>
        <form id="signup-form">
            <input type="email" id="email-reg" placeholder="Correo electr√≥nico" required><br><br>
            <input type="password" id="password-reg" placeholder="Contrase√±a (min 6 caracteres)" required><br><br>
            <button type="submit" class="manual">Registrarse</button>
        </form>
        <button class="auto" onclick="mostrarLogin()">Ya tengo cuenta</button>
    </div>

    <div id="panel-riego" style="display:none;">
        <button id="logout-btn" class="off">Cerrar Sesi√≥n</button>

        <h1>üå± Panel de Riego V3</h1>
        <div id="humedadBox" class="dato">Humedad actual: <span id="humedad">--</span>%</div>
        <div class="riego">Estado de riego: <span id="estadoRiego">--</span></div>
        <div class="origen">Origen del cambio: <span id="origenRiego">--</span></div>
        <button class="on" onclick="activarRiego()">Activar riego</button>
        <button class="off" onclick="desactivarRiego()">Desactivar riego</button>
        <button class="auto" onclick="activarAutomatico()">Modo autom√°tico</button>
        <button class="manual" onclick="activarManual()">Modo manual</button>

        <div>
            <h3>üìÖ Consultar historial</h3>
            <select id="mes">
                <option value="1">Enero</option>
                <option value="9" selected>Septiembre</option>
                </select>
            <select id="anio">
                <option value="2024">2024</option>
                <option value="2025" selected>2025</option>
            </select>
            <button onclick="cargarHistorial()">Ver historial</button>
        </div>

        <canvas id="graficoHumedad" width="400" height="200"></canvas>
    </div>

    <script>
        // CONFIGURACI√ìN: REEMPLAZA LOS VALORES CON LOS DE TU PROYECTO RIEGO-HIBRIDO-V3
        const firebaseConfig = {
            apiKey: "[TU_API_KEY_DE_V3]",
            authDomain: "riego-hibrido-v3.firebaseapp.com",
            databaseURL: "https://riego-hibrido-v3-default-rtdb.firebaseio.com",
            projectId: "riego-hibrido-v3",
            storageBucket: "[TU_STORAGE_BUCKET_DE_V3]",
            messagingSenderId: "[TU_SENDER_ID_DE_V3]",
            appId: "[TU_APP_ID_DE_V3]"
        };

        // Inicializaci√≥n y Servicios
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth(); 

        // ------------------------------------------------------------------
        // üíß L√ìGICA DE AUTENTICACI√ìN üíß
        // ------------------------------------------------------------------

        function iniciarSesion(email, password) {
            auth.signInWithEmailAndPassword(email, password)
                .catch((error) => {
                    console.error("Error de Login:", error.message);
                    alert("Error de acceso: Correo o contrase√±a incorrectos.");
                });
        }

        function registrarUsuario(email, password) {
            auth.createUserWithEmailAndPassword(email, password)
                .then(() => {
                    alert("Registro exitoso. ¬°Inicia sesi√≥n!");
                    mostrarLogin();
                })
                .catch((error) => {
                    console.error("Error de Registro:", error.message);
                    alert("Error al registrar: " + error.message);
                });
        }
        
        function cerrarSesion() {
            auth.signOut();
        }
        
        // Controladores de Vistas
        function mostrarLogin() {
            document.getElementById('signup-box').style.display = 'none';
            document.getElementById('login-box').style.display = 'block';
        }
        function mostrarRegistro() {
            document.getElementById('login-box').style.display = 'none';
            document.getElementById('signup-box').style.display = 'block';
        }

        // Observador del Estado de Autenticaci√≥n (Muestra/Oculta el panel)
        auth.onAuthStateChanged(user => {
            if (user) {
                // Usuario logueado: Muestra el panel, esconde el login
                document.getElementById('login-box').style.display = 'none';
                document.getElementById('signup-box').style.display = 'none';
                document.getElementById('panel-riego').style.display = 'block';
                cargarUltimaSemana(); // Carga de datos inicial
            } else {
                // Usuario NO logueado: Muestra el login, esconde el panel
                document.getElementById('login-box').style.display = 'block';
                document.getElementById('signup-box').style.display = 'none';
                document.getElementById('panel-riego').style.display = 'none';
            }
        });

        // Conexi√≥n de Formularios (Event Listeners)
        document.getElementById('login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            iniciarSesion(email, password);
        });

        document.getElementById('signup-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('email-reg').value;
            const password = document.getElementById('password-reg').value;
            registrarUsuario(email, password);
        });
        
        document.getElementById('logout-btn').addEventListener('click', cerrarSesion);

        // ------------------------------------------------------------------
        // ‚öôÔ∏è TU L√ìGICA DE RIEGO (Funciona S√ìLO cuando hay sesi√≥n) ‚öôÔ∏è
        // ------------------------------------------------------------------

        db.ref("riego/humedad").on("value", snapshot => {
            // L√≥gica de humedad (manteniendo tu c√≥digo original)
            const valor = snapshot.val();
            const humedad = document.getElementById("humedad");
            const box = document.getElementById("humedadBox");
            humedad.textContent = valor ?? "--";

            if (valor < 30) box.style.background = "#e74c3c";
            else if (valor < 60) box.style.background = "#f1c40f";
            else box.style.background = "#2ecc71";
        });

        db.ref("riego/bomba").on("value", snapshot => {
            // L√≥gica de bomba
            const estado = snapshot.val();
            let texto = "--";
            if (estado === "ON") texto = "üíß Activada";
            else if (estado === "OFF") texto = "üõë Desactivada";
            document.getElementById("estadoRiego").textContent = texto;
        });

        db.ref("riego/origen").on("value", snapshot => {
            // L√≥gica de origen
            const origen = snapshot.val();
            let texto = "--";
            if (origen === "auto") texto = "üîÑ Autom√°tico";
            else if (origen === "manual") texto = "üßë‚Äçüîß Manual";
            document.getElementById("origenRiego").textContent = texto;
        });

        // Tus funciones de control (usan 'db' que ya est√° inicializado)
        function activarRiego() {
            db.ref("riego/bomba").set("ON");
            db.ref("riego/origen").set("manual");
            alert("üíß Riego activado manualmente");
        }
        // ... (resto de tus funciones: desactivarRiego, activarAutomatico, activarManual, cargarHistorial) ...
        // ... (Tu c√≥digo de Chart.js y funciones de historial permanece igual) ...

    </script>
</body>
</html>
