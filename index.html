<!DOCTYPE html>
<html>
<head>
Â  <meta charset="UTF-8">
Â  <title>ðŸŒ± Panel de Riego</title>
Â  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
Â  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
Â  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
Â  <style>
Â  Â  body { font-family: sans-serif; text-align: center; padding: 2em; background: #f0f0f0; }
Â  Â  h1 { color: #2c3e50; }
Â  Â  .dato { font-size: 2em; margin: 1em 0; padding: 0.5em; border-radius: 10px; display: inline-block; }
Â  Â  .riego, .origen { margin-top: 1em; font-weight: bold; color: #2980b9; }
Â  Â  button, select { padding: 0.5em 1em; font-size: 1em; margin: 0.5em; border-radius: 5px; }
Â  Â  button { border: none; cursor: pointer; color: white; }
Â  Â  button:hover { opacity: 0.9; }
Â  Â  .on { background: #27ae60; }
Â  Â  .off { background: #c0392b; }
Â  Â  .auto { background: #3498db; }
Â  Â  .manual { background: #8e44ad; }
Â  Â  canvas { margin-top: 2em; }
Â  </style>
</head>
<body>
Â  <h1>ðŸŒ± Panel de Riego</h1>
Â  <div id="humedadBox" class="dato">Humedad actual: <span id="humedad">--</span>%</div>
Â  <div class="riego">Estado de riego: <span id="estadoRiego">--</span></div>
Â  <div class="origen">Origen del cambio: <span id="origenRiego">--</span></div>
Â  <button class="on" onclick="activarRiego()">Activar riego</button>
Â  <button class="off" onclick="desactivarRiego()">Desactivar riego</button>
Â  <button class="auto" onclick="activarAutomatico()">Modo automÃ¡tico</button>
Â  <button class="manual" onclick="activarManual()">Modo manual</button>

Â  <div>
Â  Â  <h3>ðŸ“… Consultar historial</h3>
Â  Â  <select id="mes">
Â  Â  Â  <option value="1">Enero</option>
Â  Â  Â  <option value="2">Febrero</option>
Â  Â  Â  <option value="3">Marzo</option>
Â  Â  Â  <option value="4">Abril</option>
Â  Â  Â  <option value="5">Mayo</option>
Â  Â  Â  <option value="6">Junio</option>
Â  Â  Â  <option value="7">Julio</option>
Â  Â  Â  <option value="8">Agosto</option>
Â  Â  Â  <option value="9" selected>Septiembre</option>
Â  Â  Â  <option value="10">Octubre</option>
Â  Â  Â  <option value="11">Noviembre</option>
Â  Â  Â  <option value="12">Diciembre</option>
Â  Â  </select>
Â  Â  <select id="anio">
Â  Â  Â  <option value="2024">2024</option>
Â  Â  Â  <option value="2025" selected>2025</option>
Â  Â  </select>
Â  Â  <button onclick="cargarHistorial()">Ver historial</button>
Â  </div>

Â  <canvas id="graficoHumedad" width="400" height="200"></canvas>

Â  <script>
Â  Â // **ESTA ES LA CONFIGURACIÃ“N SIMPLIFICADA QUE DEBE FUNCIONAR**
Â  Â const firebaseConfig = {
Â  Â  Â apiKey: "AIzaSyDm4UQ_tOSC36IfWjHwNOP2aYAy_iMjE9c",
Â  Â  Â databaseURL: "https://riego-hibrido-v3-default-rtdb.firebaseio.com",
Â  Â };

Â  Â  firebase.initializeApp(firebaseConfig);
Â  Â  const db = firebase.database();

Â  Â  db.ref("riego/humedad").on("value", snapshot => {
Â  Â  Â  const valor = snapshot.val();
Â  Â  Â  const humedad = document.getElementById("humedad");
Â  Â  Â  const box = document.getElementById("humedadBox");
Â  Â  Â  humedad.textContent = valor ?? "--";

Â  Â  Â  if (valor < 30) box.style.background = "#e74c3c";
Â  Â  Â  else if (valor < 60) box.style.background = "#f1c40f";
Â  Â  Â  else box.style.background = "#2ecc71";
Â  Â  });

Â  Â  db.ref("riego/bomba").on("value", snapshot => {
Â  Â  Â  const estado = snapshot.val();
Â  Â  Â  let texto = "--";
Â  Â  Â  if (estado === "ON") texto = "ðŸ’§ Activada";
Â  Â  Â  else if (estado === "OFF") texto = "ðŸ›‘ Desactivada";
Â  Â  Â  document.getElementById("estadoRiego").textContent = texto;
Â  Â  });

Â  Â  db.ref("riego/origen").on("value", snapshot => {
Â  Â  Â  const origen = snapshot.val();
Â  Â  Â  let texto = "--";
Â  Â  Â  if (origen === "auto") texto = "ðŸ”„ AutomÃ¡tico";
Â  Â  Â  else if (origen === "manual") texto = "ðŸ§‘â€ðŸ”§ Manual";
Â  Â  Â  document.getElementById("origenRiego").textContent = texto;
Â  Â  });

Â  Â  function activarRiego() {
Â  Â  Â  db.ref("riego/bomba").set("ON");
Â  Â  Â  db.ref("riego/origen").set("manual");
Â  Â  Â  alert("ðŸ’§ Riego activado manualmente");
Â  Â  }

Â  Â  function desactivarRiego() {
Â  Â  Â  db.ref("riego/bomba").set("OFF");
Â  Â  Â  db.ref("riego/origen").set("manual");
Â  Â  Â  alert("ðŸ›‘ Riego desactivado manualmente");
Â  Â  }

Â  Â  function activarAutomatico() {
Â  Â  Â  db.ref("riego/origen").set("auto");
Â  Â  Â  alert("ðŸ”„ Modo automÃ¡tico activado");
Â  Â  }

Â  Â  function activarManual() {
Â  Â  Â  db.ref("riego/origen").set("manual");
Â  Â  Â  alert("ðŸ§‘â€ðŸ”§ Modo manual activado");
Â  Â  }

Â  Â  const ctx = document.getElementById("graficoHumedad").getContext("2d");
Â  Â  const grafico = new Chart(ctx, {
Â  Â  Â  type: "line",
Â  Â  Â  data: {
Â  Â  Â  Â  labels: [],
Â  Â  Â  Â  datasets: [{
Â  Â  Â  Â  Â  label: "Humedad (%)",
Â  Â  Â  Â  Â  data: [],
Â  Â  Â  Â  Â  borderColor: "#27ae60",
Â  Â  Â  Â  Â  backgroundColor: "rgba(39,174,96,0.2)",
Â  Â  Â  Â  Â  fill: true,
Â  Â  Â  Â  Â  tension: 0.3
Â  Â  Â  Â  }]
Â  Â  Â  },
Â  Â  Â  options: {
Â  Â  Â  Â  scales: {
Â  Â  Â  Â  Â  x: { title: { display: true, text: "Fecha y hora" } },
Â  Â  Â  Â  Â  y: { min: 0, max: 100, title: { display: true, text: "Humedad (%)" } }
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  });

Â  Â  function cargarUltimaSemana() {
Â  Â  Â  const hoy = new Date();
Â  Â  Â  const aÃ±o = hoy.getFullYear();
Â  Â  Â  const mes = hoy.getMonth() + 1;
Â  Â  Â  const diaActual = hoy.getDate();
Â  Â  Â  const diasVisibles = 7;

Â  Â  Â  db.ref(`riego/historial/${aÃ±o}/${mes}`).on("value", snapshot => {
Â  Â  Â  Â  const datos = snapshot.val();
Â  Â  Â  Â  const etiquetas = [];
Â  Â  Â  Â  const valores = [];

Â  Â  Â  Â  for (const dia in datos) {
Â  Â  Â  Â  Â  const diaNum = parseInt(dia);
Â  Â  Â  Â  Â  if (diaNum >= diaActual - diasVisibles && diaNum <= diaActual) {
Â  Â  Â  Â  Â  Â  for (const hora in datos[dia]) {
Â  Â  Â  Â  Â  Â  Â  etiquetas.push(`${dia}/${mes} ${hora}`);
Â  Â  Â  Â  Â  Â  Â  valores.push(datos[dia][hora]);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  grafico.data.labels = etiquetas;
Â  Â  Â  Â  grafico.data.datasets[0].data = valores;
Â  Â  Â  Â  grafico.update();
Â  Â  Â  });
Â  Â  }

Â  Â  function cargarHistorial() {
Â  Â  Â  const mes = document.getElementById("mes").value;
Â  Â  Â  const anio = document.getElementById("anio").value;

Â  Â  Â  db.ref(`riego/historial/${anio}/${mes}`).once("value").then(snapshot => {
Â  Â  Â  Â  const datos = snapshot.val();
Â  Â  Â  Â  const etiquetas = [];
Â  Â  Â  Â  const valores = [];

Â  Â  Â  Â  for (const dia in datos) {
Â  Â  Â  Â  Â  for (const hora in datos[dia]) {
Â  Â  Â  Â  Â  Â  etiquetas.push(`${dia}/${mes} ${hora}`);
Â  Â  Â  Â  Â  Â  valores.push(datos[dia][hora]);
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  grafico.data.labels = etiquetas;
Â  Â  Â  Â  grafico.data.datasets[0].data = valores;
Â  Â  Â  Â  grafico.update();
Â  Â  Â  });
Â  Â  }

Â  Â  cargarUltimaSemana(); // Carga inicial
Â  </script>
</body>
</html>
