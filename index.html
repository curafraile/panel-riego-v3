<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Panel de Riego H√≠brido</title>
<!-- Carga de Tailwind CSS para una est√©tica limpia y responsiva -->
<script src="https://cdn.tailwindcss.com"></script>
<style>
/* Reset de fuente y estilo base */
body { 
    font-family: 'Inter', sans-serif; 
    text-align: center; 
    padding: 1em; 
    background: #f4f7f6; /* Fondo suave */
}
h1 { 
    color: #2c3e50; 
    margin-bottom: 1em; 
    font-weight: 700; 
}
.zona-box { 
    display: inline-block; 
    width: 180px; 
    padding: 1.5em 1em; 
    margin: 0.5em; 
    border-radius: 12px; 
    font-size: 1.5em; 
    color: white; 
    transition: background 0.3s, transform 0.1s; 
    box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); 
}
/* Estilos para botones grandes y t√°ctiles */
button, select { 
    padding: 0.75em 1.5em; 
    font-size: 1em; 
    margin: 0.5em; 
    border-radius: 8px; 
    cursor: pointer; 
    color: white; 
    border: none; 
    transition: background 0.2s, transform 0.1s;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    min-width: 150px; /* Tama√±o m√≠nimo para bot√≥n */
}
button:hover { opacity: 0.9; transform: translateY(-1px); }
.on { background: #2ecc71; } /* Verde para ON */
.off { background: #e74c3c; } /* Rojo para OFF */
.auto { background: #3498db; }
.manual { background: #9b59b6; } /* P√∫rpura para Manual */

/* Responsive: Asegura que los elementos se apilen en m√≥viles */
@media (max-width: 600px) {
    .zona-box { width: 90%; display: block; margin: 0.5em auto; }
    button { width: 45%; margin: 0.4em; }
    .estado { font-size: 1.1em; }
}
</style>
</head>
<body>
<!-- Dependencias de Firebase y Chart.js -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div class="max-w-4xl mx-auto bg-white p-6 rounded-xl shadow-2xl">

    <h1 class="text-3xl font-bold mt-4">üå± Panel de Riego H√≠brido</h1>

    <!-- Cajas de estado de humedad -->
    <div class="mt-6 flex flex-wrap justify-center gap-4">
        <div id="zona1Box" class="zona-box bg-blue-500">Zona 1: <span id="humedad1">--</span>%</div>
        <div id="zona2Box" class="zona-box bg-orange-500">Zona 2: <span id="humedad2">--</span>%</div>
    </div>

    <!-- Indicadores de estado de riego -->
    <div class="estado mt-8 text-gray-800">Estado de riego: <span id="estadoRiego" class="font-extrabold text-lg">--</span></div>
    <div class="estado text-gray-800">Origen: <span id="origenRiego" class="font-extrabold text-lg">--</span></div>

    <!-- Controles de zona y botones -->
    <div class="mt-8">
        <label for="selectZona" class="font-semibold text-gray-700 block mb-2">Seleccionar zona para control manual:</label>
        <select id="selectZona" class="text-gray-900 border border-gray-300 p-2 rounded-lg shadow-inner">
            <option value="1">Zona 1</option>
            <option value="2">Zona 2</option>
            <option value="0">Ambas</option>
        </select>
    </div>

    <div class="mt-6 flex flex-wrap justify-center gap-3">
        <!-- CR√çTICO: Botones de control manual -->
        <button class="on" onclick="activarRiego()">Activar riego</button>
        <button class="off" onclick="desactivarRiego()">Desactivar riego</button>
        <button class="auto" onclick="activarAutomatico()">Modo autom√°tico</button>
        <button class="manual" onclick="activarManual()">Modo manual</button>
    </div>

    <!-- Secci√≥n de historial -->
    <div class="mt-10 border-t pt-6">
        <h3 class="text-xl font-semibold text-gray-700">üìÖ Consultar historial</h3>
        <p class="text-sm text-gray-500">Mostrando datos de los √∫ltimos 7 d√≠as por defecto.</p>
        <button class="bg-gray-500 hover:bg-gray-700" onclick="cargarHistorialPersonalizado()">Ver √∫ltimos 7 d√≠as</button>
    </div>

    <!-- Gr√°fico -->
    <div class="mt-6 p-4 bg-gray-50 rounded-lg shadow-inner">
        <canvas id="graficoHumedad"></canvas>
    </div>

</div>

<script>
// ======================= CONFIGURACI√ìN DE FIREBASE =======================
// POR FAVOR, VERIFICA que la apiKey y databaseURL sean las correctas para tu proyecto
const firebaseConfig = {
    apiKey: "AIzaSyDm4UQ_tOSC36IfWjHwNOP2aYAy_iMjE9c", 
    databaseURL: "https://riego-hibrido-v3-default-rtdb.firebaseio.com",
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const estadoRef = db.ref("riego");
const historialRef = db.ref("riego/historial");


// ======================= ACTUALIZACI√ìN EN TIEMPO REAL =======================

// Humedad (zona1 y zona2)
estadoRef.child("zona1").on("value", snap => {
    const val = snap.val();
    document.getElementById("humedad1").textContent = val ?? "--";
    const box = document.getElementById("zona1Box");
    // L√≥gica de colores: Rojo (Seco <30), Amarillo (Normal 30-60), Azul (H√∫medo >60)
    box.style.backgroundColor = val < 30 ? "#e74c3c" : val < 60 ? "#f1c40f" : "#3498db";
});
estadoRef.child("zona2").on("value", snap => {
    const val = snap.val();
    document.getElementById("humedad2").textContent = val ?? "--";
    const box = document.getElementById("zona2Box");
    // L√≥gica de colores: Rojo (Seco <30), Naranja (Normal 30-60), Naranja oscuro (H√∫medo >60)
    box.style.backgroundColor = val < 30 ? "#e74c3c" : val < 60 ? "#f39c12" : "#e67e22";
});

// Estado de riego y origen
estadoRef.child("bomba").on("value", snap => {
    const val = snap.val();
    let texto = "--";
    if (val === "ON") texto = "üíß ACTIVADA"; else if (val === "OFF" || val === "off") texto = "üõë DESACTIVADA";
    document.getElementById("estadoRiego").textContent = texto;
});
estadoRef.child("origen").on("value", snap => {
    const val = snap.val();
    document.getElementById("origenRiego").textContent = val === "auto" ? "üîÑ Autom√°tico" : "üßë‚Äçüîß Manual";
});


// ======================= FUNCIONES DE CONTROL CR√çTICAS (CORREGIDAS) =======================

/**
 * Pone el sistema en modo manual (permite al usuario usar los botones de Riego).
 */
function activarManual() {
    estadoRef.child("origen").set("manual");
    estadoRef.child("bomba").set("OFF"); 
    estadoRef.child("motor/zona1").set(false);
    estadoRef.child("motor/zona2").set(false);
    console.log("Modo manual activado.");
    alert("üßë‚Äçüîß Modo manual activado. Usa los botones Activar/Desactivar riego.");
}

/**
 * Pone el sistema en modo autom√°tico (el ESP32 toma el control basado en humedad).
 */
function activarAutomatico() {
    estadoRef.child("origen").set("auto");
    estadoRef.child("bomba").set("OFF");
    estadoRef.child("motor/zona1").set(false);
    estadoRef.child("motor/zona2").set(false);
    console.log("Modo autom√°tico activado.");
    alert("üîÑ Modo autom√°tico activado. Sensores tienen el control.");
}

/**
 * Activa la bomba y el motor para la zona seleccionada (SOLO FUNCIONA EN MODO MANUAL).
 */
function activarRiego() {
    const origenText = document.getElementById("origenRiego").textContent;
    // CR√çTICO: Verifica que el modo sea manual antes de enviar la orden
    if (!origenText.includes("Manual")) {
        alert("¬°Error! Debe pulsar 'Modo manual' (P√∫rpura) antes de activar el riego.");
        return;
    }

    const z = document.getElementById("selectZona").value;
    const zona1_activo = (z === "1" || z === "0"); // True si es Zona 1 o Ambas
    const zona2_activo = (z === "2" || z === "0"); // True si es Zona 2 o Ambas

    // 1. Env√≠a la orden de ENCENDER la bomba (El ESP32 lo lee)
    estadoRef.child("bomba").set("ON");
    
    // 2. Env√≠a la orden de movimiento del motor a la zona (El ESP32 lo lee)
    estadoRef.child("motor/zona1").set(zona1_activo); // true/false
    estadoRef.child("motor/zona2").set(zona2_activo); // true/false
    
    console.log(`Riego activado manualmente en la Zona ${z}.`);
    alert(`üíß Riego activado manualmente en la Zona ${z}.`);
}

/**
 * Desactiva la bomba y el motor.
 */
function desactivarRiego() {
    // 1. Env√≠a la orden de APAGAR la bomba
    estadoRef.child("bomba").set("OFF");
    
    // 2. Env√≠a la orden de APAGAR el motor
    estadoRef.child("motor/zona1").set(false);
    estadoRef.child("motor/zona2").set(false);
    
    console.log("Riego desactivado manualmente.");
    alert("üõë Riego desactivado manualmente.");
}


// ======================= L√ìGICA DE GR√ÅFICO DE HISTORIAL =======================

const ctx = document.getElementById("graficoHumedad").getContext("2d");
const grafico = new Chart(ctx, {
    type: "line",
    data: {
        labels: [],
        datasets: [
            { label: "Zona 1", data: [], borderColor: "#3498db", backgroundColor: "rgba(52,152,219,0.2)", fill: true, tension: 0.3 },
            { label: "Zona 2", data: [], borderColor: "#e67e22", backgroundColor: "rgba(230,126,34,0.2)", fill: true, tension: 0.3 }
        ]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false, 
        scales: {
            x: { title: { display: true, text: "Fecha y hora" } },
            y: { min: 0, max: 100, title: { display: true, text: "Humedad (%)" } }
        }
    }
});

function cargarHistorial(tiempoInicial) {
    historialRef
        .orderByKey() 
        .startAt(tiempoInicial.toString()) 
        .once("value")
        .then(snap => {
            const datos = snap.val() || {};
            const etiquetas = [], data1 = [], data2 = [];

            for (const timestampKey in datos) {
                const registro = datos[timestampKey];
                // El timestamp es en SEGUNDOS (del ESP32)
                const date = new Date(parseInt(timestampKey) * 1000); 

                const etiqueta = `${date.getDate().toString().padStart(2, '0')}/${(date.getMonth() + 1).toString().padStart(2, '0')} ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;

                etiquetas.push(etiqueta);
                data1.push(registro.z1 ?? 0);
                data2.push(registro.z2 ?? 0);
            }

            grafico.data.labels = etiquetas;
            grafico.data.datasets[0].data = data1;
            grafico.data.datasets[1].data = data2;
            grafico.update();

            if (etiquetas.length === 0) {
                console.warn("No hay datos disponibles en el rango de tiempo seleccionado.");
            }
        })
        .catch(error => {
            console.error("Error al cargar el historial:", error);
            alert("Hubo un error al cargar el historial.");
        });
}

function cargarHistorialPersonalizado() {
    // Calcula la marca de tiempo (timestamp) de hace 7 d√≠as en segundos
    const tiempoHace7Dias = Math.floor(Date.now() / 1000) - (7 * 24 * 3600); 
    cargarHistorial(tiempoHace7Dias);
    alert("Cargando historial de los √∫ltimos 7 d√≠as...");
}

// Carga inicial al cargar la p√°gina: muestra los √∫ltimos 7 d√≠as
window.onload = cargarHistorialPersonalizado;

// Asegurar que el gr√°fico se redibuje al cambiar el tama√±o de la ventana
window.onresize = function() {
    grafico.resize();
};

</script>
</body>
</html>
